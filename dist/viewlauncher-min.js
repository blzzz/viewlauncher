!function(t,e){"function"==typeof define&&define.amd?define(["jquery","backbone","underscore","exports"],e):"object"==typeof exports?module.exports=e(require("$"),require("Backbone"),require("_"),require("exports")):t.Viewlauncher=e(t.$,t.Backbone,t._,t.exports)}(this,function(t,e,n,i){var s,r,o,c,u,l,a,h={}.hasOwnProperty,f=function(t,e){function n(){this.constructor=t}for(var i in e)h.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};return s=s=function(){function e(t,e,n){return this.$el1=t,this.$el2=e,this.path=n,this}return e.prototype.$el1=null,e.prototype.$el2=null,e.prototype.path="",e.prototype.getAttributesOf=function(t,e){var i;return null==e&&(e=!1),i=[],t.each(function(){var t,s,r,o,c,u;for(r={},u=this.attributes,o=0,c=u.length;c>o;o++)t=u[o],s=!e||n.indexOf(e,t.name)>=0,s&&(r[t.name]=t.value);return i.push(r)}),i},e.prototype.find=function(t){return this.find1(t).add(this.find2(t))},e.prototype.find1=function(t){return null==t&&(t=""),this.$el1.find(t)},e.prototype.find2=function(t){return null==t&&(t=""),this.$el2.find(t)},e.prototype.html1=function(t){return null==t&&(t=""),this.$el1.html()},e.prototype.html2=function(t){return null==t&&(t=""),this.$el2.html()},e.prototype.sameSize=function(t,e){return null==e&&(e="*"),this.find1(t).filter(e).length===this.find2(t).filter(e).length},e.prototype.$=function(e,n){var i,s,r,o,c,u;return null==e&&(e=""),null==n&&(n={sync:"none"}),this.sameSize(e)?(o=n.filter,u=n.sync,s=""!==e?this.find1(e):this.$el1,r=""!==e?this.find2(e):this.$el2,i=this.find(e).filter(o||"*"),u?(c=this,i.each(function(){var e,n,i;return i=t(this).index(),n=s.eq(i),e=r.eq(i),("content"===u||"all"===u)&&c.syncContent(n,e),"attributes"===u||"all"===u?c.syncAttributes(n,c.getAttributesOf(e)):void 0})):i):!1},e.prototype.syncHtmlOf=function(t){return this.syncContentOf(t,"html")},e.prototype.syncTextOf=function(t){return this.syncContentOf(t,"text")},e.prototype.syncContentOf=function(t,e){return null==t&&(t=""),this.sameSize(t)?(this.syncContent(this.find1(t),this.find2(t),e),!0):!1},e.prototype.syncContent=function(e,n,i){return null==i&&(i="html"),e.each(function(e){return t(this)[i](n.eq(e)[i]())})},e.prototype.classesOf=function(t){return this.syncAttributesOf(t,["class"])},e.prototype.idsOf=function(t){return this.syncAttributesOf(t,["id"])},e.prototype.stylesOf=function(t){return this.syncAttributesOf(t,["style"])},e.prototype.syncAttributesOf=function(t,e){return null==t&&(t=""),this.sameSize(t)?(this.syncAttributes(this.find1(t),this.getAttributesOf(this.find2(t),e)),!0):!1},e.prototype.syncAttributes=function(e,i){return e.each(function(e){return t(this).removeAttr(n.keys(i[e]).join(" ")).attr(i[e])})},e}(),c=e.Model.extend({defaults:{href:"untitled-page",html:"",$html:null,bodyClasses:"",title:"untitled page"},fetching:null,fetch:function(e,n){var i,s;return i=this,s=i.collection.config.root+"/"+i.get("href"),this.fetching=t.ajax({type:"GET",url:s}).done(function(t){return i.parseHtml(t),n.call(e,i)}).fail(function(t){throw new Error("Couldn't load page "+s+" ("+t.statusText+")")})},parseHtml:function(e){var i,s;return this.set("html",e),this.set("$html",i=t(e)),(s=e.match(/<body[^>]+class="\s*([^"]*)\s*"[^>]*>/))&&this.set("bodyClasses",n.compact(s[1].split(" "))),this.set("title",i.filter("title").text()),this},is:function(t){var e;return e=this.get("bodyClasses"),n.indexOf(e,t)>=0},$:function(t){return this.get("$html").find(t)},sync:function(e,n){return null==e&&(e=""),null==n&&(n=t("html")),new s(n.find(e),this.$(e),e)}}),o=e.Collection.extend({config:{},model:c,initialize:function(t,e){return null==t&&(t=[]),this.config=e,0===t.length?this.add(new this.model({href:this.config.initialHref})).parseHtml(this.config.initialHtml):void 0},byHref:function(t,e,n){var i;return t="/"===t.slice(0,1)?t.slice(1):t,(i=this.findWhere({href:t}))?n.call(e,i):this.add({href:t}).fetch(e,n)}}),l=function(){function e(t){this.reset(t)}return e.prototype.reset=function(t){var e,i,s,r,o,c;if(this.views)for(c=this.views,i=0,r=c.length;r>i;i++)e=c[i],e.remove();if(this.views=[],t)for(n.isArray(t)||(t=[t]),s=0,o=t.length;o>s;s++)e=t[s],this.push(e);return this},e.prototype.push=function(t){return this.views.push(t),this.length=this.views.length},e.prototype.each=function(t,e,i){var s,r,o,c,u,l,a;for(null==e&&(e=this.views),null==i&&(i=this),r=n.isFunction(t),o=!r&&n.isString(t),a=[],s=u=0,l=e.length;l>u;s=++u)c=e[s],a.push(r?t.call(i,c,s):o?c[t].call(i,c,s):void 0);return a},e.prototype.find=function(t,e){return this.where(t,e)[0]},e.prototype.where=function(t,e){var i,s;return s=[],i=n.isArray(t),this.each(function(n){var r;return r=i?this.resolveArrayPath(n,t):n[t],r===e?s.push(n):void 0}),s},e.prototype.first=function(){return this.views.slice(0,1)[0]},e.prototype.last=function(){return this.views.slice(-1)[0]},e.prototype.set=function(t,e){return this.each(n.isObject(t)?function(e){var n,i,s;s=[];for(n in t)i=t[n],s.push(e[n]=i);return s}:function(n){return n[t]=e}),this},e.prototype.get=function(t,e){var i;return i=e?{}:[],this.each(function(s){var r,o;return o=function(){switch(!1){case!n.isArray(t):return this.resolveArrayPath(s,t);case!n.isFunction(s[t]):return s[t].call(s);default:return s[t]}}.call(this),e?(r=function(){switch(!1){case!n.isArray(e):return this.resolveArrayPath(s,e);default:return e}}.call(this),i[r]=o):o?i.push(o):void 0}),i},e.prototype.waitFor=function(e,i,s,r,o,c){var u,l,a,h,f;return null==i&&(i=this),null==o&&(o=0),null==c&&(c=2e4),l=!1,f=o>0,f&&setTimeout(function(){return l?s.call(i):f=!1},o),c>0&&(a=setTimeout(function(){throw Error("max wait duration of "+c+" exceeded for function "+e)},c)),h=n.isArray(e),u=this.each(function(i){var s,o;return s=new t.Deferred,o=h?this.resolveArrayPath(i,e):i[e],n.isArray(r)?o.apply(i,[s.resolve].concat(r)):o.call(i,s.resolve),s}),t.when.apply(t,u).done(function(){return a&&clearTimeout(a),f||s.call(i),l=!0}),this},e.prototype.resolveArrayPath=function(t,e){var n,i,s;for(i=0,s=e.length;s>i;i++)n=e[i],t=t[n];return t},e.prototype.$=function(e){var i,s;return i=t([]),s=n.filter(this.views,function(t){return t.$el.is(e)}),s.length>0&&this.each(function(t){return i=i.add(t.$el)},s),i},e}(),a=function(i){function s(t){s.__super__.constructor.call(this,t)}return f(s,i),s.prototype.ViewPrototype={initialize:function(t){this.config=t},cycle:{load:function(t){return t.call(this)},launch:function(){},update:function(){},unload:function(t){return t.call(this)}}},s.prototype.findAndLoad=function(t,e,i,s,r){var o,c,u,l;return o=n.filter(t,function(t){return e.is(":has("+t.selector+")")}),u=function(){var t,n,i;for(i=[],c=t=0,n=o.length;n>t;c=++t)l=o[c],i.push(l.requirePath?l.requirePath:this.createViewInstances(e,l,l));return i}.call(this),this.loadInstances(i,r,s),this},s.prototype.createViewInstances=function(i,s,r){var o;return o=this,i.find(s.selector).each(function(){var i,c,u;return c=n.extend({},o.ViewPrototype),i=n.extend({},c.cycle),u=n.extend(c,r),u.cycle=n.extend(i,u.cycle),r=e.View.extend(u),o.push(new r(n.extend({el:t(this)},s)))})},s.prototype.loadInstances=function(t,e,n){return null==n&&(n=0),this.waitFor(["cycle","load"],t,e,null,n)},s.prototype.launchInstances=function(){return this.each(function(t){return t.cycle.launch.call(t)})},s.prototype.updateInstances=function(t,e){return this.each(function(n){var i;return i=t.sync(n.config.selector,e),n.cycle.update.call(n,i)})},s.prototype.unloadInstances=function(t,e){return this.waitFor(["cycle","unload"],this,function(){return this.reset(),e.call(t)})},s}(l),u=e.View.extend({sections:null,views:null,states:null,useClassTransitions:!1,initialize:function(t){return this.config=t,this.states=this.config.section.transitionStates,this.useClassTransitions=n.isArray(this.states),this.$el.html(this.config.html)},to:function(t,e){var n;return null==e&&(e=0),(n=this.states[t])?this.toStateClass(n)?void 0:0===e?(this.$el.css(n),this):this.$el.animate(n,e).promise():void 0},toStateClass:function(t){return this.useClassTransitions?(this.$el.removeClass(this.states.join(" ")).addClass(t),!0):!1},findSynced:function(t,e){return this.$(t).add(e.$(t))},hasBodyClass:function(t){return this.config.page.is(t)},size:function(){return{width:this.$el.width(),height:this.$el.height()}},pos:function(){return{top:this.$el.position().top,left:this.$el.position().left}},off:function(){return{top:this.$el.offset().top,left:this.$el.offset().left}}}),i.Section=e.View.extend({sections:null,views:null,contents:null,transitionStates:{before:{display:"block",opacity:0,position:"absolute",top:0,left:0},after:{position:"absolute",opacity:1},"final":{position:"static"}},transitionPresets:{cut:function(t,e,n){return t&&t.to("after"),e.to("after"),n()},fadein:function(t,e,n,i){return null==i&&(i=1e3),t&&t.to("after"),e.to("after",i).done(n)},whitefade:function(t,e,n,i){return null==i&&(i=1e3),t?t.to("after").to("before",i/2).done(e.to("after",i/2)).done(n):e.to("after",i/2,n)},crossfade:function(t,e,n,i){return null==i&&(i=1e3),t&&t.to("after").to("before",i,n),e.to("after",i).done(n)}},events:{"click a[href]":function(t){return this.getLauncher().requestClickedLink(t,this)}},initialize:function(t){return this.config=t,this.config.launcher.trigger("sectionAdded",this.el,this.config)},findAndLoad:function(t,e){var i,s,r,o,c,u,l,a,h,f,d,p,g,y;r=!this.config.launcher,u=this.getLauncher(),l=e?u.config.minLoadingTime:0,d={sections:[],views:[]},y=this.config.launchables;for(p in y)switch(o=y[p],a=o.section,c=o.launchables,h=n.compact([this.config.sectionSelector,p]).join(" "),s={section:this,selector:p,launchables:c,sectionSelector:h,launcher:u},!1){case!a:n.isString(a)&&(a={requirePath:a}),d.sections.push(n.extend(s,{type:"section",extension:a}));break;case!o:n.isString(o)&&(o={requirePath:o}),d.views.push(n.extend(s,{type:"view"},o));break;default:throw new Error("Invalid Hash Type: Use either a string or a section hash as value for "+p)}return this.contents||this.render(),f=d.sections,g=d.views,i=this.contents.last().$el,this.loadSections(i,f,function(){return this.sections.waitFor("findAndLoad",this,function(){return this.loadViews(i,g,l,function(){return e===!0?this.sections.waitFor("playTransition",this,function(){return this.views.launchInstances(!1),u.trigger("sectionReady",this.sections.get("el"),this.el),t.call(this)}):(u.trigger("subSectionLoaded",this.config.selector),this.cycle&&this.cycle.launch&&this.cycle.launch.call(this),t.call(this))})})})},render:function(t,e){var n,i,s,r,o;return n=t?t.sync(this.config.selector,e).html2():this.$el.html(),r=this.config.launcher||this,null==t&&(t=r.currPage||r.nextPage),s=!this.config.launcher,i=!this.contents,i&&!s&&this.$el.empty(),o=new u({section:this,className:r.config.sectionContentClassName,html:n,page:t}),o.to(this.contents?"before":"final"),s?o.setElement(this.el):this.$el.append(o.$el),i?this.resetContent(o):this.contents.push(o),this},resetContent:function(t){return this.contents=new l(t)},playTransition:function(t){var e,i,s,r,o;return e=this.contents.length>1?this.contents.first():null,s=this.contents.last(),r=this,i=function(){return e&&r.unloadLaunchables(function(){return e.remove()}),r.launchViews(),r.resetContent(s.to("final")),t.call(r)},o=n.isString(this.transition)?this.transitionPresets[this.transition]:this.transition,o.call(this,e,s,i,this.config.duration)},launchViews:function(t){return null==t&&(t=!0),this.views.launchInstances(),t?this.sections.each(function(t){return t.launchViews()}):void 0},unloadLaunchables:function(t){var e;return e=this.contents.first(),e.views.unloadInstances(this,function(){return e.sections.waitFor("unloadLaunchables",this,t)})},loadSections:function(t,e,s){var r,o,c,u,a;return o=n.filter(e,function(e){return t.is(":has("+e.selector+")")}),u=n.filter(o,function(t){return n.isString(t.requirePath)}),c=this.config.launcher||this,this.sections=this.contents.last().sections=(new l).reset(function(){var e,n,s;for(s=[],e=0,n=o.length;n>e;e++)a=o[e],r=i.Section.extend(a.extension),a=new r({el:t.find(a.selector),launchables:a.launchables,selector:a.selector,sectionSelector:a.sectionSelector,section:a.section,launcher:c,imagesToLoad:c.config.imagesToLoad}),s.push(a);return s}()),s.call(this)},loadViews:function(t,e,n,i){return this.views=this.contents.last().views=(new a).findAndLoad(e,t,this,n,function(){var t;return t=this,this.loadContentAssets(function(){return i.call(t)})})},loadContentAssets:function(t){return t.call(this)},reload:function(t,e,n){return this.getLauncher().currPage?this.reloadSections(t,function(){return this.views.updateInstances(t,this.$el),this.sections.waitFor("playTransition",n,e)}):this.findAndLoad(e,!0)},reloadSections:function(t,e){var n;return n=this.$el,this.sections.each(function(e){return e.render(t,n)}),this.sections.waitFor("findAndLoad",this,e,[!0])},getLauncher:function(){return this.config.launcher||this}}),r=i.Section.extend({currPage:null,nextPage:null,pages:null,router:null,loading:!1,config:{maxTransitionTime:1e4,root:"",pushState:!0,sectionContentClassName:"section-content",imagesToLoad:"img:not(.dont-preload)",minLoadingTime:0},initialize:function(t){return this.config=n.extend(this.config,t,{sectionSelector:""})},start:function(){var n,i,s;return s=this,n=e.Router.extend({routes:{"":"request","*path":"request"},request:function(t){return s.requestPage(t,"navigated")}}),this.router=new n,e.history.start({pushState:this.config.pushState,root:this.config.root,silent:!0}),this.trigger("historyStarted",this.router),i=e.history.fragment,this.pages=new o(this.config.pages,{root:this.config.root,initialHref:i,initialHtml:t("html").html()}),this.requestPage(i,"called"),this},requestClickedLink:function(n,i){var s,r,o;return null==i&&(i=this),n.stopPropagation(),s=t(n.currentTarget),r={prop:s.prop("href"),attr:s.attr("href")},o=location.protocol+"//"+location.host+this.config.root,r.prop.slice(0,o.length)===o&&(n.preventDefault?n.preventDefault():n.returnValue=!1,this.requestPage(r.attr,"linked",{section:i}))?e.history.navigate(r.attr,{silent:!0}):void 0},getSectionToRefresh:function(t,e){var n,i,s;switch(s=e.section,i=e.href,n=this.config.getSectionByHrefChange,t){case"called":return this;case"linked":return s&&s.sections.length>0?s:this;case"navigated":return n?n.call(this,this.currPage.get("href"),i):this;default:throw new Error("invalid request type")}},requestPage:function(e,i,s){var r,o,c;return null==s&&(s={}),this.loading&&"pending"===this.loading.state()||(null!=(c=this.currPage)?c.get("href"):void 0)===e?!1:(o=this.getSectionToRefresh(i,n.extend(s,{href:e})),r=this,this.trigger("pageRequested",{href:e,type:i,section:o,sections:null!=o?o.sections:void 0}),this.pages.byHref(e,this,function(e){var n;return this.trigger("pageFetched",e),n=this.loading=new t.Deferred,this.nextPage=e,o.reload(e,function(){return this.nextPage=null,this.currPage=e,this.trigger("transitionDone",this.el),n.resolve(r)},this)}),!0)}})});