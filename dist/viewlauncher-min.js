!function(t,e){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("underscore"),require("backbone")):t.Viewlauncher=e(t.$,t._,t.Backbone)}(this,function(t,e,n){var i,s,r,o,c,u,l,a,h={}.hasOwnProperty,f=function(t,e){function n(){this.constructor=t}for(var i in e)h.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};return i=i=function(){function n(t,e,n){return this.$el1=t,this.$el2=e,this.path=n,this}return n.prototype.$el1=null,n.prototype.$el2=null,n.prototype.path="",n.prototype.getAttributesOf=function(t,n){var i;return null==n&&(n=!1),i=[],t.each(function(){var t,s,r,o,c,u;for(r={},u=this.attributes,o=0,c=u.length;c>o;o++)t=u[o],s=!n||e.indexOf(n,t.name)>=0,s&&(r[t.name]=t.value);return i.push(r)}),i},n.prototype.find=function(t){return this.find1(t).add(this.find2(t))},n.prototype.find1=function(t){return null==t&&(t=""),this.$el1.find(t)},n.prototype.find2=function(t){return null==t&&(t=""),this.$el2.find(t)},n.prototype.html1=function(t){return null==t&&(t=""),this.$el1.html()},n.prototype.html2=function(t){return null==t&&(t=""),this.$el2.html()},n.prototype.sameSize=function(t,e){return null==e&&(e="*"),this.find1(t).filter(e).length===this.find2(t).filter(e).length},n.prototype.$=function(e,n){var i,s,r,o,c,u;return null==e&&(e=""),null==n&&(n={sync:"none"}),this.sameSize(e)?(o=n.filter,u=n.sync,s=""!==e?this.find1(e):this.$el1,r=""!==e?this.find2(e):this.$el2,i=this.find(e).filter(o||"*"),u?(c=this,i.each(function(){var e,n,i;return i=t(this).index(),n=s.eq(i),e=r.eq(i),("content"===u||"all"===u)&&c.syncContent(n,e),"attributes"===u||"all"===u?c.syncAttributes(n,c.getAttributesOf(e)):void 0})):i):!1},n.prototype.syncHtmlOf=function(t){return this.syncContentOf(t,"html")},n.prototype.syncTextOf=function(t){return this.syncContentOf(t,"text")},n.prototype.syncContentOf=function(t,e){return null==t&&(t=""),this.sameSize(t)?(this.syncContent(this.find1(t),this.find2(t),e),!0):!1},n.prototype.syncContent=function(e,n,i){return null==i&&(i="html"),e.each(function(e){return t(this)[i](n.eq(e)[i]())})},n.prototype.classesOf=function(t){return this.syncAttributesOf(t,["class"])},n.prototype.idsOf=function(t){return this.syncAttributesOf(t,["id"])},n.prototype.stylesOf=function(t){return this.syncAttributesOf(t,["style"])},n.prototype.syncAttributesOf=function(t,e){return null==t&&(t=""),this.sameSize(t)?(this.syncAttributes(this.find1(t),this.getAttributesOf(this.find2(t),e)),!0):!1},n.prototype.syncAttributes=function(n,i){return n.each(function(n){return t(this).removeAttr(e.keys(i[n]).join(" ")).attr(i[n])})},n}(),o=n.Model.extend({defaults:{href:"untitled-page",html:"",$html:null,bodyClasses:"",title:"untitled page"},fetching:null,fetch:function(n,i){var s;return s=this.collection.config.loadRoot+"/"+this.get("href"),this.fetching=t.ajax({type:"GET",url:s}).done(e.bind(function(t){return this.parseHtml(t),i.call(n,this)},this)).fail(function(t){throw new Error("Couldn't load page "+s+" ("+t.statusText+")")})},parseHtml:function(n){var i,s;return this.set("html",n),this.set("$html",i=t(n)),(s=n.match(/<body[^>]+class="\s*([^"]*)\s*"[^>]*>/))&&this.set("bodyClasses",e.compact(s[1].split(" "))),this.set("title",i.filter("title").text()),this},is:function(t){return e.indexOf(this.get("bodyClasses"),t)>=0},$:function(t){return this.get("$html").find(t)},sync:function(e,n){return null==e&&(e=""),null==n&&(n=t("html")),new i(n.find(e),this.$(e),e)}}),r=n.Collection.extend({config:{},model:o,initialize:function(t,e){return null==t&&(t=[]),this.config=e,0===t.length?this.add(new this.model({href:this.config.initialHref})).parseHtml(this.config.initialHtml):void 0},byHref:function(t,e,n){var i;return t="/"===t.slice(0,1)?t.slice(1):t,(i=this.findWhere({href:t}))?n.call(e,i):this.add({href:t}).fetch(e,n)}}),u=function(){function n(t){this.reset(t)}return n.prototype.reset=function(t){var n,i,s,r,o,c;if(this.views)for(c=this.views,i=0,r=c.length;r>i;i++)n=c[i],n.remove();if(this.views=[],t)for(e.isArray(t)||(t=[t]),s=0,o=t.length;o>s;s++)n=t[s],this.push(n);return this},n.prototype.push=function(t){return this.views.push(t),this.length=this.views.length},n.prototype.each=function(t,n,i){var s,r,o,c,u,l,a;for(null==n&&(n=this.views),null==i&&(i=this),r=e.isFunction(t),o=!r&&e.isString(t),a=[],s=u=0,l=n.length;l>u;s=++u)c=n[s],a.push(r?t.call(i,c,s):o?c[t].call(i,c,s):void 0);return a},n.prototype.find=function(t,e){return this.where(t,e)[0]},n.prototype.where=function(t,n){var i,s;return s=[],i=e.isArray(t),this.each(function(e){var r;return r=i?this.resolveArrayPath(e,t):e[t],r===n?s.push(e):void 0}),s},n.prototype.first=function(){return this.views.slice(0,1)[0]},n.prototype.last=function(){return this.views.slice(-1)[0]},n.prototype.set=function(t,n){return this.each(e.isObject(t)?function(e){var n,i,s;s=[];for(n in t)i=t[n],s.push(e[n]=i);return s}:function(e){return e[t]=n}),this},n.prototype.get=function(t,n){var i;return i=n?{}:[],this.each(function(s){var r,o;return o=function(){switch(!1){case!e.isArray(t):return this.resolveArrayPath(s,t);case!e.isFunction(s[t]):return s[t].call(s);default:return s[t]}}.call(this),n?(r=function(){switch(!1){case!e.isArray(n):return this.resolveArrayPath(s,n);default:return n}}.call(this),i[r]=o):o?i.push(o):void 0}),i},n.prototype.waitFor=function(n,i,s,r,o,c){var u,l,a,h,f;return null==i&&(i=this),null==o&&(o=0),null==c&&(c=2e4),l=!1,f=o>0,f&&setTimeout(function(){return l?s.call(i):f=!1},o),c>0&&(a=setTimeout(function(){throw Error("max wait duration of "+c+" exceeded for function "+n)},c)),h=e.isArray(n),u=this.each(function(i){var s,o;return s=new t.Deferred,o=h?this.resolveArrayPath(i,n):i[n],e.isArray(r)?o.apply(i,[s.resolve].concat(r)):o.call(i,s.resolve),s}),t.when.apply(t,u).done(function(){return a&&clearTimeout(a),f||s.call(i),l=!0}),this},n.prototype.resolveArrayPath=function(t,e){var n,i,s;for(i=0,s=e.length;s>i;i++)n=e[i],t=t[n];return t},n.prototype.$=function(n){var i,s;return i=t([]),s=e.filter(this.views,function(t){return t.$el.is(n)}),s.length>0&&this.each(function(t){return i=i.add(t.$el)},s),i},n}(),l=function(i){function s(t){s.__super__.constructor.call(this,t)}return f(s,i),s.prototype.ViewPrototype={initialize:function(t){this.config=t},cycle:{load:function(t){return t.call(this)},launch:function(){},update:function(){},unload:function(t){return t.call(this)}}},s.prototype.findAndLoad=function(t,n,i,s,r){var o,c,u,l;return o=e.filter(t,function(t){return n.is(":has("+t.selector+")")}),u=function(){var t,e,i;for(i=[],c=t=0,e=o.length;e>t;c=++t)l=o[c],i.push(l.requirePath?l.requirePath:this.createViewInstances(n,l,l));return i}.call(this),this.loadInstances(i,r,s),this},s.prototype.createViewInstances=function(i,s,r){var o;return o=this,i.find(s.selector).each(function(){var i,c,u;return c=e.extend({},o.ViewPrototype),i=e.extend({},c.cycle),u=e.extend(c,r),u.cycle=e.extend(i,u.cycle),r=n.View.extend(u),o.push(new r(e.extend({el:t(this)},s)))})},s.prototype.loadInstances=function(t,e,n){return null==n&&(n=0),this.waitFor(["cycle","load"],t,e,null,n)},s.prototype.launchInstances=function(){return this.each(function(t){return t.cycle.launch.call(t)})},s.prototype.updateInstances=function(t,e){return this.each(function(n){var i;return i=t.sync(n.config.selector,e),n.cycle.update.call(n,i)})},s.prototype.unloadInstances=function(t,e){return this.waitFor(["cycle","unload"],this,function(){return this.reset(),e.call(t)})},s}(u),c=n.View.extend({sections:null,views:null,states:null,useClassTransitions:!1,initialize:function(t){return this.config=t,this.states=this.config.section.transitionStates,this.useClassTransitions=e.isArray(this.states),this.$el.html(this.config.html)},to:function(t,e){var n;return null==e&&(e=0),(n=this.states[t])?this.toStateClass(n)?void 0:0===e?(this.$el.css(n),this):this.$el.animate(n,e).promise():void 0},toStateClass:function(t){return this.useClassTransitions?(this.$el.removeClass(this.states.join(" ")).addClass(t),!0):!1},findSynced:function(t,e){return this.$(t).add(e.$(t))},hasBodyClass:function(t){return this.config.page.is(t)},size:function(){return{width:this.$el.width(),height:this.$el.height()}},pos:function(){return{top:this.$el.position().top,left:this.$el.position().left}},off:function(){return{top:this.$el.offset().top,left:this.$el.offset().left}}}),a=a||{},a.Section=n.View.extend({sections:null,views:null,contents:null,transitionStates:{before:{display:"block",opacity:0,position:"absolute",top:0,left:0},after:{position:"absolute",opacity:1},"final":{position:"static"}},transitionPresets:{cut:function(t,e,n){return t&&t.to("after"),e.to("after"),n()},fadein:function(t,e,n,i){return null==i&&(i=1e3),t&&t.to("after"),e.to("after",i).done(n)},whitefade:function(t,e,n,i){return null==i&&(i=1e3),t?t.to("after").to("before",i/2).done(e.to("after",i/2)).done(n):e.to("after",i/2,n)},crossfade:function(t,e,n,i){return null==i&&(i=1e3),t&&t.to("after").to("before",i,n),e.to("after",i).done(n)}},events:{"click a[href]":function(t){return this.getLauncher().requestClickedLink(t,this)}},initialize:function(t){return this.config=t,this.config.launcher.trigger("sectionAdded",this.el,this.config)},findAndLoad:function(t,n){var i,s,r,o,c,u,l,a,h,f,d,p,g,y;r=!this.config.launcher,u=this.getLauncher(),l=n?u.config.minLoadingTime:0,d={sections:[],views:[]},y=this.config.launchables;for(p in y)switch(o=y[p],a=o.section,c=o.launchables,h=e.compact([this.config.sectionSelector,p]).join(" "),s={section:this,selector:p,launchables:c,sectionSelector:h,launcher:u},!1){case!a:e.isString(a)&&(a={requirePath:a}),d.sections.push(e.extend(s,{type:"section",extension:a}));break;case!o:e.isString(o)&&(o={requirePath:o}),d.views.push(e.extend(s,{type:"view"},o));break;default:throw new Error("Invalid Hash Type: Use either a string or a section hash as value for "+p)}return this.contents||this.render(),f=d.sections,g=d.views,i=this.contents.last().$el,this.loadSections(i,f,function(){return this.sections.waitFor("findAndLoad",this,function(){return this.loadViews(i,g,l,function(){return n===!0?this.sections.waitFor("playTransition",this,function(){return this.views.launchInstances(!1),u.trigger("sectionReady",this.sections.get("el"),this.el),t.call(this)}):(u.trigger("subSectionLoaded",this.config.selector),this.cycle&&this.cycle.launch&&this.cycle.launch.call(this),t.call(this))})})})},render:function(t,e){var n,i,s,r,o;return n=t?t.sync(this.config.selector,e).html2():this.$el.html(),r=this.config.launcher||this,null==t&&(t=r.currPage||r.nextPage),s=!this.config.launcher,i=!this.contents,i&&!s&&this.$el.empty(),o=new c({section:this,className:r.config.sectionContentClassName,html:n,page:t}),o.to(this.contents?"before":"final"),s?o.setElement(this.el):this.$el.append(o.$el),i?this.resetContent(o):this.contents.push(o),this},resetContent:function(t){return this.contents=new u(t)},playTransition:function(t){var n,i,s,r,o;return n=this.contents.length>1?this.contents.first():null,s=this.contents.last(),r=this,i=function(){return n&&r.unloadLaunchables(function(){return n.remove()}),r.launchViews(),r.resetContent(s.to("final")),t.call(r)},o=e.isString(this.transition)?this.transitionPresets[this.transition]:this.transition||this.transitionPresets.cut,o.call(this,n,s,i,this.config.duration)},launchViews:function(t){return null==t&&(t=!0),this.views.launchInstances(),t?this.sections.each(function(t){return t.launchViews()}):void 0},unloadLaunchables:function(t){var e;return e=this.contents.first(),e.views.unloadInstances(this,function(){return e.sections.waitFor("unloadLaunchables",this,t)})},loadSections:function(t,n,i){var s,r,o,c,l,h;return r=e.filter(n,function(e){return t.is(":has("+e.selector+")")}),c=e.filter(r,function(t){return e.isString(t.requirePath)}),o=this.config.launcher||this,this.sections=this.contents.last().sections=(new u).reset(function(){var n,i,c;for(c=[],n=0,i=r.length;i>n;n++)l=r[n],h=l.extension.transitionStates,h&&(h=e.extend({},h),delete l.extension.transitionStates),s=a.Section.extend(l.extension),l=new s({el:t.find(l.selector),launchables:l.launchables,selector:l.selector,sectionSelector:l.sectionSelector,section:l.section,launcher:o,imagesToLoad:o.config.imagesToLoad}),h&&e.extend(l.transitionStates,h),c.push(l);return c}()),i.call(this)},loadViews:function(t,e,n,i){return this.views=this.contents.last().views=new l,this.views.findAndLoad(e,t,this,n,function(){var t;return t=this,this.loadContentAssets(function(){return i.call(t)})})},loadContentAssets:function(t){return t.call(this)},reload:function(t,e,n){return this.getLauncher().currPage?this.reloadSections(t,function(){return this.views.updateInstances(t,this.$el),this.sections.waitFor("playTransition",n,e)}):this.findAndLoad(e,!0)},reloadSections:function(t,e){var n;return n=this.$el,this.sections.each(function(e){return e.render(t,n)}),this.sections.waitFor("findAndLoad",this,e,[!0])},getLauncher:function(){return this.config.launcher||this}}),s=a.Section.extend({currPage:null,nextPage:null,pages:null,router:null,loading:!1,config:{maxTransitionTime:1e4,root:"",loadRoot:"",pushState:!0,sectionContentClassName:"section-content",imagesToLoad:"img:not(.dont-preload)",minLoadingTime:0},initialize:function(t){return this.config=e.extend(this.config,t,{sectionSelector:""})},start:function(){var e,i,s;return s=this,e=n.Router.extend({routes:{"":"request","*path":"request"},request:function(t){return s.requestPage(t,"navigated")}}),this.router=new e,n.history.start({pushState:this.config.pushState,root:this.config.root,silent:!0}),this.config.loadRoot=location.protocol+"//"+location.host+this.config.root,this.trigger("historyStarted",this.router),i=n.history.fragment,this.pages=new r(this.config.pages,{root:this.config.root,loadRoot:this.config.loadRoot,initialHref:i,initialHtml:t("html").html()}),this.requestPage(i,"called"),this},requestClickedLink:function(e,i){var s,r,o;return null==i&&(i=this),e.stopPropagation(),s=t(e.currentTarget),r={prop:s.prop("href"),attr:s.attr("href")},o=this.config.loadRoot,r.prop.slice(0,o.length)===o&&(e.preventDefault?e.preventDefault():e.returnValue=!1,this.requestPage(r.attr,"linked",{section:i}))?n.history.navigate(r.attr,{silent:!0}):void 0},getSectionToRefresh:function(t,e){var n,i,s;switch(s=e.section,i=e.href,n=this.config.getSectionByHrefChange,t){case"called":return this;case"linked":return s&&s.sections.length>0?s:this;case"navigated":return n?n.call(this,this.currPage.get("href"),i):this;default:throw new Error("invalid request type")}},requestPage:function(n,i,s){var r,o,c;return null==s&&(s={}),this.loading&&"pending"===this.loading.state()||(null!=(c=this.currPage)?c.get("href"):void 0)===n?!1:(o=this.getSectionToRefresh(i,e.extend(s,{href:n})),r=this,this.trigger("pageRequested",{href:n,type:i,section:o,sections:null!=o?o.sections:void 0}),this.pages.byHref(n,this,function(e){var n;return this.trigger("pageFetched",e),n=this.loading=new t.Deferred,this.nextPage=e,o.reload(e,function(){return this.nextPage=null,this.currPage=e,this.trigger("transitionDone",this.el),n.resolve(r)},this)}),!0)}})});